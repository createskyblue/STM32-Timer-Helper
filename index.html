<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>定时器计算器</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
</head>
<body class="bg-gray-100 min-h-screen flex items-center justify-center p-4">
    <div class="bg-white rounded-lg shadow-xl p-6 w-full max-w-lg">
        <h1 class="text-2xl font-bold text-center text-gray-800 mb-6">定时器计算器</h1>
        
        <div class="bg-blue-50 p-4 rounded-md mb-6">
            <p class="text-center text-blue-800 font-medium">计算公式:</p>
            <p class="text-center text-blue-700 mt-2">$$\text{定时时间} = \frac{1 + \text{TIM_Prescaler}}{\text{Tim_Clock}} \times (1 + \text{TIM_Period})$$</p>
        </div>
        
        <form id="timerForm" class="space-y-4">
            <div>
                <label for="timClock" class="block text-sm font-medium text-gray-700 mb-1">时钟主频 (MHz)</label>
                <input type="number" id="timClock" step="0.1" min="0.1" required
                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500">
            </div>
            
            <div class="flex space-x-4">
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <input type="radio" name="mode" value="time" checked class="mr-2">定时时间
                    </label>
                    <div class="flex">
                        <input type="number" id="timeValue" step="0.001" min="0.001" disabled
                            class="w-full px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="timeUnit" disabled class="border border-gray-300 rounded-r-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="1">秒 (S)</option>
                            <option value="1e-3">毫秒 (ms)</option>
                            <option value="1e-6">微秒 (μs)</option>
                            <option value="1e-9">纳秒 (ns)</option>
                        </select>
                    </div>
                </div>
                
                <div class="flex-1">
                    <label class="block text-sm font-medium text-gray-700 mb-1">
                        <input type="radio" name="mode" value="frequency" class="mr-2">定时频率
                    </label>
                    <div class="flex">
                        <input type="number" id="freqValue" step="1" min="1" disabled
                            class="w-full px-3 py-2 border border-gray-300 rounded-l-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                        <select id="freqUnit" disabled class="border border-gray-300 rounded-r-md focus:outline-none focus:ring-2 focus:ring-blue-500">
                            <option value="1">Hz</option>
                            <option value="1e3">kHz</option>
                            <option value="1e6">MHz</option>
                        </select>
                    </div>
                </div>
            </div>
            
            <button type="submit" class="w-full bg-blue-500 hover:bg-blue-600 text-white font-medium py-2 px-4 rounded-md transition duration-300">
                计算
            </button>
        </form>
        
        <div id="result" class="mt-6 hidden">
            <h2 class="text-lg font-semibold text-gray-800 mb-3">计算结果</h2>
            <div class="bg-gray-50 p-4 rounded-md">
                <p class="text-gray-600">预分频系数 (TIM_Prescaler): <span id="prescaler" class="font-medium text-gray-800"></span></p>
                <p class="text-gray-600">自动重载值 (TIM_Period): <span id="period" class="font-medium text-gray-800"></span></p>
                <p class="text-gray-600">计算定时时间: <span id="calculatedTime" class="font-medium text-gray-800"></span> 秒</p>
                <p class="text-gray-600">误差: <span id="error" class="font-medium text-gray-800"></span>%</p>
            </div>
        </div>
    </div>

    <script>
        // 启用/禁用输入框
        const modeInputs = document.querySelectorAll('input[name="mode"]');
        const timeInput = document.getElementById('timeValue');
        const freqInput = document.getElementById('freqValue');
        
        modeInputs.forEach(input => {
            input.addEventListener('change', () => {
                if (input.value === 'time') {
                    timeInput.disabled = false;
                    freqInput.disabled = true;
                    freqInput.value = '';
                } else {
                    timeInput.disabled = true;
                    freqInput.disabled = false;
                    timeInput.value = '';
                }
            });
        });
        
        // 启用/禁用单位选择框
        const timeUnitSelect = document.getElementById('timeUnit');
        const freqUnitSelect = document.getElementById('freqUnit');
        
        modeInputs.forEach(input => {
            input.addEventListener('change', () => {
                if (input.value === 'time') {
                    timeInput.disabled = false;
                    timeUnitSelect.disabled = false;
                    freqInput.disabled = true;
                    freqUnitSelect.disabled = true;
                    freqInput.value = '';
                } else {
                    timeInput.disabled = true;
                    timeUnitSelect.disabled = true;
                    freqInput.disabled = false;
                    freqUnitSelect.disabled = false;
                    timeInput.value = '';
                }
            });
        });
        
        // 计算函数
        document.getElementById('timerForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // 获取输入值
            const timClock = parseFloat(document.getElementById('timClock').value);
            const mode = document.querySelector('input[name="mode"]:checked').value;
            let targetValue;
            
            if (mode === 'time') {
                const timeValue = parseFloat(timeInput.value);
                const timeUnit = parseFloat(timeUnitSelect.value);
                targetValue = timeValue * timeUnit;
            } else {
                const freqValue = parseFloat(freqInput.value);
                const freqUnit = parseFloat(freqUnitSelect.value);
                targetValue = 1 / (freqValue * freqUnit);
            }
            
            // 验证输入
            if (isNaN(timClock) || isNaN(targetValue) || timClock <= 0 || targetValue <= 0) {
                showError('请输入有效的数值');
                return;
            }
            
            // 计算最优参数
            const result = calculateOptimalParameters(timClock * 1000000, targetValue);
            
            // 检查计算结果
            if (result.error === Infinity) {
                showError('无法计算出合适的参数，请检查输入值是否合理');
                return;
            }
            
            // 显示结果
            const resultDiv = document.getElementById('result');
            
            // 自动适应单位
            const { value: formattedTime, unit: timeUnit } = formatValueWithUnit(result.calculatedTime, 's');
            
            resultDiv.innerHTML = `
                <h2 class="text-lg font-semibold text-gray-800 mb-3">计算结果</h2>
                <div class="bg-gray-50 p-4 rounded-md">
                    <p class="text-gray-600">预分频系数 (TIM_Prescaler): <span id="prescaler" class="font-medium text-gray-800">${result.prescaler}</span></p>
                    <p class="text-gray-600">自动重载值 (TIM_Period): <span id="period" class="font-medium text-gray-800">${result.period}</span></p>
                    <p class="text-gray-600">计算定时时间: <span id="calculatedTime" class="font-medium text-gray-800">${formattedTime}</span> ${timeUnit}</p>
                    <p class="text-gray-600">误差: <span id="error" class="font-medium text-gray-800">${result.error.toFixed(6)}</span>%</p>
                </div>
            `;
            resultDiv.classList.remove('hidden');
        });
        
        function calculateOptimalParameters(timClock, targetTime) {
            let bestPrescaler = 0;
            let bestPeriod = 0;
            let bestError = Infinity;
            let bestCalculatedTime = 0;
            
            // 遍历所有可能的预分频系数 (0-65535)
            for (let prescaler = 0; prescaler <= 65535; prescaler++) {
                // 计算自动重载值
                const period = (targetTime * timClock) / (prescaler + 1) - 1;
                
                // 检查是否在有效范围内
                if (period >= 1 && period <= 65535) {
                    const intPeriod = Math.round(period);
                    const calculatedTime = ((1.0 + prescaler) / timClock) * (1.0 + intPeriod);
                    const error = Math.abs((calculatedTime - targetTime) / targetTime) * 100;
                    
                    if (error < bestError) {
                        bestError = error;
                        bestPrescaler = prescaler;
                        bestPeriod = intPeriod;
                        bestCalculatedTime = calculatedTime;
                    }
                }
                
                // 如果找到了误差为0的解，直接返回
                if (bestError === 0) break;
            }
            
            return {
                prescaler: bestPrescaler,
                period: bestPeriod,
                calculatedTime: bestCalculatedTime,
                error: bestError
            };
        }
        
        function showError(message) {
            const resultDiv = document.getElementById('result');
            resultDiv.innerHTML = `
                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative" role="alert">
                    <strong class="font-bold">错误: </strong>
                    <span class="block sm:inline">${message}</span>
                </div>
            `;
            resultDiv.classList.remove('hidden');
        }
        
        function formatValueWithUnit(value, unit) {
            const absValue = Math.abs(value);
            
            if (absValue >= 1.0) {
                return { value: value.toFixed(3), unit: unit };
            } else if (absValue >= 0.001) {
                return { value: (value * 1000).toFixed(3), unit: 'm' + unit };
            } else if (absValue >= 0.000001) {
                return { value: (value * 1000000).toFixed(3), unit: 'μ' + unit };
            } else {
                return { value: (value * 1000000000).toFixed(3), unit: 'n' + unit };
            }
        }
    </script>
</body>
</html>
